
# Import functions and data through source script -------------------------

source("R/source_script.R")


# UI ----------------------------------------------------------------------


# Define theme
jameel_theme <- bs_theme(
  version = 5,
  base_font = "Imperial Sans",
  heading_font = "Imperial Sans Display",
  primary = "#0000cd",
  secondary = "#ab1940",
  success = "#0000ae",
  bg = "#fdfdfd",
  fg = "#021c35",
  font_scale = 1
)

# Add @font-face CSS rules for custom fonts in /www/
jameel_theme <- bs_add_rules(jameel_theme, "
  @font-face {
    font-family: 'Imperial Sans';
    src: url('ImperialSansText-Regular.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }

  @font-face {
    font-family: 'Imperial Sans Display';
    src: url('ImperialSansDisplay-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
  }
")


ui <- fluidPage(
  # theme = jameel_theme,
  theme = bs_theme(present = "litera"),
  # Custom styling for sidebar + DataTable scroll
  tags$head(
    tags$style(HTML("
    .sidebar-custom {
      font-size: 0.85rem;
    }
    .sidebar-custom .form-control,
    .sidebar-custom .selectize-input {
      font-size: 0.85rem;
    }
    .sidebar-custom h4 {
      font-size: 1rem;
      margin-top: 1rem;
    }
    .dataTables_wrapper {
      width: 100% !important;
    }
    .dataTables_scrollBody {
      max-height: 200px !important;
      overflow-y: auto !important;
    }
    .dt-head-wrap {
      white-space: normal !important;
      word-wrap: break-word;
    }
    #sidebar-panel {
      resize: horizontal;
      overflow: auto;
      min-width: 200px;
      max-width: 500px;
    }
  ")),
    tags$script('
      var dimension = [0, 0];
      $(document).on("shiny:connected", function(e) {
        dimension[0] = window.innerWidth;
        dimension[1] = window.innerHeight;
        Shiny.onInputChange("dimension", dimension);
      });
      $(window).resize(function(e) {
        dimension[0] = window.innerWidth;
        dimension[1] = window.innerHeight;
        Shiny.onInputChange("dimension", dimension);
      });')
  ),
  div(
    class = "d-flex align-items-center justify-content-between p-3 mb-3 border-bottom",
    
    # Title on left
    div(
      h2("Jameel Institute Crisis Vaccination Planner (JICVP)", 
         class = "mb-0", 
         style = "font-weight: 500; color: #0000cd; font-size: x-large;")
    ),
    
    # Logo on right
    img(src = "imperial_ji_logo.png", height = "50px")
  ),
  
  navset_card_underline(
    
    nav_panel("Model Setup",
              layout_columns(
                col_widths = c(2, 10),
                
                # Sidebar
                div(
                  id = "sidebar-panel1",
                  class = "sidebar-custom p-3 bg-light border rounded",
                  style = "display: flex; flex-direction: column; height: auto;",
                  
                  selectInput("country", "Country", selected = "Palestine", choices = countries$name),
                  uiOutput("pop_input"),
                  selectInput("disease", "Disease of interest", choices = diseases_of_interest$disease, selected = "Measles"),
                  uiOutput("r0_input"),
                  
                  sliderInput("years", "Years of simulation", 1, min = 1, max = 5),
                  
                  h4("Future events"),
                  div(
                    style = "display: flex; flex-direction: column;",
                    DTOutput("input_coverage_table"),
                    div(style = "margin-top: 15px;"),
                    actionButton("run_model", "Run simulations",
                                 icon("play"), 
                                 style = "color: #fff; background-color: #ab1940; border-color: #021c35")
                  )
                  
                ),
                
                # Main content
                div(
                  class = "p-3",
                  plotOutput("model_plot") %>% withSpinner(color = "#E5E4E2")
                )
              )
    ),
    
    nav_panel("Model outputs",
              layout_columns(
                col_widths = c(2, 10),
                
                # Sidebar
                div(
                  id = "sidebar-panel",
                  class = "sidebar-custom p-3 bg-light border rounded",
                  style = "display: flex; flex-direction: column; height: auto;",
                  
                  selectInput("country", "Country", selected = "Palestine", choices = countries$name),
                  uiOutput("pop_input"),
                  selectInput("disease", "Disease of interest", choices = diseases_of_interest$disease, selected = "Measles"),
                  uiOutput("r0_input"),
                  
                  sliderInput("years", "Years of simulation", 1, min = 1, max = 5),
                  
                  h4("Future events"),
                  div(
                    style = "display: flex; flex-direction: column;",
                    DTOutput("input_coverage_table"),
                    div(style = "margin-top: 15px;"),
                    actionButton("run_model", "Run simulations",
                                 icon("play"), 
                                 style = "color: #fff; background-color: #ab1940; border-color: #021c35")
                  )
                  
                ),
                
                # Main content
                div(
                  class = "p-3",
                  plotOutput("results_plot") %>% withSpinner(color = "#E5E4E2")
                )
              )
    ),
    
    nav_panel("About",
              uiOutput("ui_overview")
    ),
    
  )
  
)


# Server ------------------------------------------------------------------

server <- function(input, output, session) {
  
  
  ## FUTRE VALUE UI -----------------------------------------------------
  last_n <- reactiveVal(3)
  
  current_data <- reactiveVal(
    data.frame(Year = 0:2, seed = rep(0, 3), `Vaccination coverage` = rep(0, 3))
  )
  
  observeEvent(input$years, {
    n_new <- input$years
    n_old <- last_n()
    df_old <- current_data()
    
    if (n_new > n_old) {
      added_rows <- data.frame(
        Year = n_old:(n_new - 1),
        seed = rep(0, n_new - n_old),
        `Vaccination coverage` = rep(0, n_new - n_old)
      )
      df_new <- rbind(df_old, added_rows)
    } else {
      df_new <- head(df_old, n_new)
    }
    
    current_data(df_new)
    last_n(n_new)
  })
  
  # TODO: User limits on values for table
  output$input_coverage_table <- renderDT({
    datatable(
      current_data(),
      editable = list(target = "cell", disable = list(columns = c(0))),
      rownames = FALSE,
      colnames = c("Year", "Seeded infections", "Vaccination <br>relative to starting (%)"),
      options = list(
        dom = 't',
        ordering = FALSE,
        #scrollY = 200,
        paging = FALSE,
        scroller = TRUE,
        columnDefs = list(
          list(className = 'dt-center', targets = 0:1),
          list(width = '50px', targets = 0),  # narrower Year column
          list(width = '200px', targets = 1), # allow coverage column more space
          list(className = 'dt-head-wrap', targets = "_all")  # wrap all headers
        )
      ),
      escape = FALSE  # needed to allow <br> in colnames
    )
  }, server = FALSE)
  
  observeEvent(input$input_coverage_table_cell_edit, {
    info <- input$input_coverage_table_cell_edit
    i <- info$row
    j <- info$col + 1  # DT is 0-indexed, R is 1-indexed
    v <- suppressWarnings(as.numeric(info$value))
    
    if (!is.na(v)) {
      df <- current_data()
      
      # Column 2: seed (no upper bound)
      if (j == 2 && v >= 0) {
        df[i, j] <- v
      }
      
      # Column 3: vaccination coverage (0â€“100%)
      if (j == 3 && v >= 0 && v <= 100) {
        df[i, j] <- v
      }
      
      current_data(df)
    }
  })
  
  ## REACTIVE UI INPUTS -----------------------------------------------------
  output$pop_input <- renderUI({
    country <- input$country
    iso3c <- countrycode::countrycode(country, "country.name.en", "iso3c")
    n <- subset(population_all, iso3 == iso3c) %>% 
      select(x0:x100) %>% 
      tail(1) %>%
      gather() %>%
      rename(age = key, population = value) %>%
      mutate(age = as.numeric(gsub("x", "", age)),
             population = population*1000) %>% 
      pull(population) %>% 
      sum() %>% round()
    numericInput("popsize", "Population size", value = n, min = 1, max = 2e9)
  })
  
  output$r0_input <- renderUI({
    selected_disease <- input$disease
    default_r0 <- diseases_of_interest$default_R0[
      diseases_of_interest$disease == selected_disease
    ]
    max_r0 <- diseases_of_interest$max_R0[
      diseases_of_interest$disease == selected_disease
    ]
    
    numericInput("r0", "Basic reproductive number (R0)", value = default_r0, max = max_r0)
  })
  
  ## PLOT 1 -----------------------------------------------------
  # Observe the button click to trigger the plot generation
  plot_output <- eventReactive(input$run_model, {
    
    # Call your custom function and generate plot based on inputs
    plot_one(country = input$country,
             n = input$popsize,
             disease = input$disease,
             r0 = input$r0)
    
  })
  
  output$model_plot <- renderPlot({
    plot_output()
  }, 
  height = function() {
    req(input$dimension)
    0.7 * as.numeric(input$dimension[2])
  },
  width = function() {
    req(input$dimension)
    0.9 * as.numeric(input$dimension[1])
  })
  
  ## PLOT 2-----------------------------------------------------
  # Observe the button click to trigger the plot generation
  plot_results <- eventReactive(input$run_model, {
    
    df <- current_data()  # get current user-edited table
    
    # Call your custom function and generate plot based on inputs
    plot_two(country = input$country,
             n = input$popsize,
             disease = input$disease,
             r0 = input$r0,
             user_df = df)
    
  })
  
  output$results_plot <- renderPlot({
    plot_results()
  }, 
  height = function() {
    req(input$dimension)
    0.7 * as.numeric(input$dimension[2])
  },
  width = function() {
    req(input$dimension)
    0.9 * as.numeric(input$dimension[1])
  })
  
  ## ABOUT -----------------------------------------------------
  
  # Fetch markdown about
  output$ui_overview <- renderUI({
    includeMarkdown("www/about.md")
  })
  
}

shinyApp(ui, server)
